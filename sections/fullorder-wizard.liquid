{% comment %}
  Full Order Wizard - フルオーダーメイド購入ウィザード

  使い方：
  1. 管理画面 > オンラインストア > テーマ > カスタマイズ
  2. 「セクションを追加」> 「Full Order Wizard」を選択
  3. 基本価格、通貨、オプションブロックを設定

  機能：
  - 6ステップの購入フロー（手の写真 → キーキャップ → スイッチ → 本体/プレート → 刻印/配列/サイズ → サマリー）
  - 手の写真アップロード必須（10MB上限）
  - リアルタイム価格計算
  - プレビュー画像自動更新
  - カートへ追加（line item properties）
  - アクセシビリティ対応
{% endcomment %}

<link rel="stylesheet" href="{{ 'fullorder-wizard.css' | asset_url }}" media="print" onload="this.media='all'">
<noscript><link rel="stylesheet" href="{{ 'fullorder-wizard.css' | asset_url }}"></noscript>

{%- style -%}
  .eg-wizard-{{ section.id }} {
    --eg-wizard-padding-y: {{ section.settings.eg_wizard_padding_y }}px;
    --eg-wizard-fg: {{ section.settings.eg_wizard_fg }};
    --eg-wizard-bg: {{ section.settings.eg_wizard_bg }};
    --eg-wizard-base-price: {{ section.settings.eg_wizard_base_price }};
  }
{%- endstyle -%}

<section
  class="eg-wizard eg-wizard-{{ section.id }}"
  role="region"
  aria-label="フルオーダーメイド購入ウィザード"
  data-section-id="{{ section.id }}"
  data-base-price="{{ section.settings.eg_wizard_base_price }}"
  data-currency="{{ section.settings.eg_wizard_currency | default: '¥' }}"
>
  <div class="eg-wizard__container">
    {%- comment -%} Progress Header {%- endcomment -%}
    <header class="eg-wizard__header">
      <h2 class="eg-wizard__title">フルオーダーメイド</h2>
      <div class="eg-wizard__progress" role="status" aria-live="polite">
        <span class="eg-wizard__progress-current" data-step-current>1</span>
        <span class="eg-wizard__progress-separator">/</span>
        <span class="eg-wizard__progress-total" data-step-total>6</span>
      </div>
      <button
        type="button"
        class="eg-wizard__close"
        aria-label="ウィザードを閉じる"
        data-wizard-close
      >
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </header>

    {%- comment -%} Steps Rail {%- endcomment -%}
    <div class="eg-wizard__rail" data-rail>
      {%- comment -%} Step 1: Hand Photo {%- endcomment -%}
      <form class="eg-step eg-step--hand" data-step="1" data-step-id="hand">
        <div class="eg-step__content">
          <h3 class="eg-step__heading">手の写真をアップロード</h3>
          <p class="eg-step__description">オーダーメイドキーボード作成のため、手の写真が必要です。</p>

          <div class="eg-wizard__upload">
            <input
              type="file"
              id="eg-wizard-hand-photo-{{ section.id }}"
              name="properties[hand_photo]"
              accept="image/jpeg,image/png,image/webp,image/heic"
              data-hand-photo-input
              required
              aria-required="true"
              aria-describedby="eg-wizard-upload-help-{{ section.id }}"
            >
            <label for="eg-wizard-hand-photo-{{ section.id }}" class="eg-wizard__upload-label">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
              </svg>
              <span>写真を選択またはドロップ</span>
            </label>
            <p id="eg-wizard-upload-help-{{ section.id }}" class="eg-wizard__upload-help">
              JPG, PNG, WebP, HEIC形式（最大10MB）
            </p>
          </div>

          <div class="eg-wizard__preview-photo" data-photo-preview style="display: none;">
            <img src="" alt="アップロードされた手の写真" data-photo-preview-img>
            <div class="eg-wizard__preview-actions">
              <button type="button" class="eg-wizard__btn-secondary" data-photo-replace>
                差し替え
              </button>
              <button type="button" class="eg-wizard__btn-danger" data-photo-delete>
                削除
              </button>
            </div>
          </div>

          <div class="eg-wizard__error" role="alert" aria-live="polite" data-upload-error style="display: none;"></div>
        </div>
      </form>

      {%- comment -%} Step 2: Keycap {%- endcomment -%}
      <form class="eg-step eg-step--keycap" data-step="2" data-step-id="keycap">
        <div class="eg-step__content">
          <h3 class="eg-step__heading">キーキャップを選択</h3>
          <p class="eg-step__description">お好みのキーキャップタイプと色を選んでください。</p>

          <div class="eg-wizard__options">
            {%- for block in section.blocks -%}
              {%- if block.settings.eg_wizard_option_code == 'keycap_type' or block.settings.eg_wizard_option_code == 'keycap_color' -%}
                <div class="eg-wizard__option-group">
                  <label class="eg-wizard__option-label">{{ block.settings.eg_wizard_option_name }}</label>

                  {%- if block.settings.eg_wizard_option_type == 'swatch' -%}
                    <div class="eg-wizard__swatches" role="radiogroup" aria-label="{{ block.settings.eg_wizard_option_name }}">
                      {%- for value in block.settings.eg_wizard_option_values -%}
                        {%- assign value_data = value | split: '|' -%}
                        {%- assign val_label = value_data[0] -%}
                        {%- assign val_value = value_data[1] | default: val_label -%}
                        {%- assign val_price = value_data[2] | default: 0 | times: 1 -%}
                        {%- assign val_stock = value_data[3] | default: 'true' -%}
                        {%- assign val_color = value_data[4] | default: val_value -%}

                        <label class="eg-wizard__swatch {% if val_stock == 'false' %}eg-wizard__swatch--disabled{% endif %}">
                          <input
                            type="radio"
                            name="properties[{{ block.settings.eg_wizard_option_code }}]"
                            value="{{ val_value }}"
                            data-price-delta="{{ val_price }}"
                            data-option-key="{{ block.settings.eg_wizard_option_code }}"
                            {% if val_stock == 'false' %}disabled aria-disabled="true"{% endif %}
                            {% if forloop.first %}checked{% endif %}
                          >
                          <span class="eg-wizard__swatch-color" style="background-color: {{ val_color }};"></span>
                          <span class="eg-wizard__swatch-label">{{ val_label }}</span>
                          {%- if val_price != 0 -%}
                            <span class="eg-wizard__swatch-price">{{ val_price | prepend: section.settings.eg_wizard_currency }}</span>
                          {%- endif -%}
                        </label>
                      {%- endfor -%}
                    </div>
                  {%- else -%}
                    <div class="eg-wizard__radios" role="radiogroup" aria-label="{{ block.settings.eg_wizard_option_name }}">
                      {%- for value in block.settings.eg_wizard_option_values -%}
                        {%- assign value_data = value | split: '|' -%}
                        {%- assign val_label = value_data[0] -%}
                        {%- assign val_value = value_data[1] | default: val_label -%}
                        {%- assign val_price = value_data[2] | default: 0 | times: 1 -%}
                        {%- assign val_stock = value_data[3] | default: 'true' -%}

                        <label class="eg-wizard__radio">
                          <input
                            type="radio"
                            name="properties[{{ block.settings.eg_wizard_option_code }}]"
                            value="{{ val_value }}"
                            data-price-delta="{{ val_price }}"
                            data-option-key="{{ block.settings.eg_wizard_option_code }}"
                            {% if val_stock == 'false' %}disabled aria-disabled="true"{% endif %}
                            {% if forloop.first %}checked{% endif %}
                          >
                          <span class="eg-wizard__radio-label">{{ val_label }}</span>
                          {%- if val_price != 0 -%}
                            <span class="eg-wizard__radio-price">{{ val_price | prepend: section.settings.eg_wizard_currency }}</span>
                          {%- endif -%}
                        </label>
                      {%- endfor -%}
                    </div>
                  {%- endif -%}
                </div>
              {%- endif -%}
            {%- endfor -%}
          </div>
        </div>
      </form>

      {%- comment -%} Step 3: Switch {%- endcomment -%}
      <form class="eg-step eg-step--switch" data-step="3" data-step-id="switch">
        <div class="eg-step__content">
          <h3 class="eg-step__heading">スイッチを選択</h3>
          <p class="eg-step__description">お好みの打鍵感のスイッチを選んでください。</p>

          <div class="eg-wizard__options">
            {%- for block in section.blocks -%}
              {%- if block.settings.eg_wizard_option_code == 'switch_model' -%}
                <div class="eg-wizard__option-group">
                  <label class="eg-wizard__option-label">{{ block.settings.eg_wizard_option_name }}</label>

                  <div class="eg-wizard__radios" role="radiogroup" aria-label="{{ block.settings.eg_wizard_option_name }}">
                    {%- for value in block.settings.eg_wizard_option_values -%}
                      {%- assign value_data = value | split: '|' -%}
                      {%- assign val_label = value_data[0] -%}
                      {%- assign val_value = value_data[1] | default: val_label -%}
                      {%- assign val_price = value_data[2] | default: 0 | times: 1 -%}
                      {%- assign val_stock = value_data[3] | default: 'true' -%}

                      <label class="eg-wizard__radio">
                        <input
                          type="radio"
                          name="properties[{{ block.settings.eg_wizard_option_code }}]"
                          value="{{ val_value }}"
                          data-price-delta="{{ val_price }}"
                          data-option-key="{{ block.settings.eg_wizard_option_code }}"
                          {% if val_stock == 'false' %}disabled aria-disabled="true"{% endif %}
                          {% if forloop.first %}checked{% endif %}
                        >
                        <span class="eg-wizard__radio-label">{{ val_label }}</span>
                        {%- if val_price != 0 -%}
                          <span class="eg-wizard__radio-price">{{ val_price | prepend: section.settings.eg_wizard_currency }}</span>
                        {%- endif -%}
                      </label>
                    {%- endfor -%}
                  </div>
                </div>
              {%- endif -%}
            {%- endfor -%}
          </div>
        </div>
      </form>

      {%- comment -%} Step 4: Case & Plate {%- endcomment -%}
      <form class="eg-step eg-step--case" data-step="4" data-step-id="case">
        <div class="eg-step__content">
          <h3 class="eg-step__heading">本体とプレートを選択</h3>
          <p class="eg-step__description">本体の色とプレートの素材を選んでください。</p>

          <div class="eg-wizard__options">
            {%- for block in section.blocks -%}
              {%- if block.settings.eg_wizard_option_code == 'case_color' or block.settings.eg_wizard_option_code == 'plate_material' -%}
                <div class="eg-wizard__option-group">
                  <label class="eg-wizard__option-label">{{ block.settings.eg_wizard_option_name }}</label>

                  {%- if block.settings.eg_wizard_option_type == 'swatch' -%}
                    <div class="eg-wizard__swatches" role="radiogroup" aria-label="{{ block.settings.eg_wizard_option_name }}">
                      {%- for value in block.settings.eg_wizard_option_values -%}
                        {%- assign value_data = value | split: '|' -%}
                        {%- assign val_label = value_data[0] -%}
                        {%- assign val_value = value_data[1] | default: val_label -%}
                        {%- assign val_price = value_data[2] | default: 0 | times: 1 -%}
                        {%- assign val_stock = value_data[3] | default: 'true' -%}
                        {%- assign val_color = value_data[4] | default: val_value -%}

                        <label class="eg-wizard__swatch {% if val_stock == 'false' %}eg-wizard__swatch--disabled{% endif %}">
                          <input
                            type="radio"
                            name="properties[{{ block.settings.eg_wizard_option_code }}]"
                            value="{{ val_value }}"
                            data-price-delta="{{ val_price }}"
                            data-option-key="{{ block.settings.eg_wizard_option_code }}"
                            {% if val_stock == 'false' %}disabled aria-disabled="true"{% endif %}
                            {% if forloop.first %}checked{% endif %}
                          >
                          <span class="eg-wizard__swatch-color" style="background-color: {{ val_color }};"></span>
                          <span class="eg-wizard__swatch-label">{{ val_label }}</span>
                          {%- if val_price != 0 -%}
                            <span class="eg-wizard__swatch-price">{{ val_price | prepend: section.settings.eg_wizard_currency }}</span>
                          {%- endif -%}
                        </label>
                      {%- endfor -%}
                    </div>
                  {%- else -%}
                    <div class="eg-wizard__radios" role="radiogroup" aria-label="{{ block.settings.eg_wizard_option_name }}">
                      {%- for value in block.settings.eg_wizard_option_values -%}
                        {%- assign value_data = value | split: '|' -%}
                        {%- assign val_label = value_data[0] -%}
                        {%- assign val_value = value_data[1] | default: val_label -%}
                        {%- assign val_price = value_data[2] | default: 0 | times: 1 -%}
                        {%- assign val_stock = value_data[3] | default: 'true' -%}

                        <label class="eg-wizard__radio">
                          <input
                            type="radio"
                            name="properties[{{ block.settings.eg_wizard_option_code }}]"
                            value="{{ val_value }}"
                            data-price-delta="{{ val_price }}"
                            data-option-key="{{ block.settings.eg_wizard_option_code }}"
                            {% if val_stock == 'false' %}disabled aria-disabled="true"{% endif %}
                            {% if forloop.first %}checked{% endif %}
                          >
                          <span class="eg-wizard__radio-label">{{ val_label }}</span>
                          {%- if val_price != 0 -%}
                            <span class="eg-wizard__radio-price">{{ val_price | prepend: section.settings.eg_wizard_currency }}</span>
                          {%- endif -%}
                        </label>
                      {%- endfor -%}
                    </div>
                  {%- endif -%}
                </div>
              {%- endif -%}
            {%- endfor -%}
          </div>
        </div>
      </form>

      {%- comment -%} Step 5: Engraving, Layout, Size {%- endcomment -%}
      <form class="eg-step eg-step--custom" data-step="5" data-step-id="custom">
        <div class="eg-step__content">
          <h3 class="eg-step__heading">カスタマイズ詳細</h3>
          <p class="eg-step__description">刻印、配列、サイズを設定してください。</p>

          <div class="eg-wizard__options">
            {%- for block in section.blocks -%}
              {%- if block.settings.eg_wizard_option_code == 'layout' or block.settings.eg_wizard_option_code == 'size' -%}
                <div class="eg-wizard__option-group">
                  <label class="eg-wizard__option-label">{{ block.settings.eg_wizard_option_name }}</label>

                  <div class="eg-wizard__radios" role="radiogroup" aria-label="{{ block.settings.eg_wizard_option_name }}">
                    {%- for value in block.settings.eg_wizard_option_values -%}
                      {%- assign value_data = value | split: '|' -%}
                      {%- assign val_label = value_data[0] -%}
                      {%- assign val_value = value_data[1] | default: val_label -%}
                      {%- assign val_price = value_data[2] | default: 0 | times: 1 -%}
                      {%- assign val_stock = value_data[3] | default: 'true' -%}

                      <label class="eg-wizard__radio">
                        <input
                          type="radio"
                          name="properties[{{ block.settings.eg_wizard_option_code }}]"
                          value="{{ val_value }}"
                          data-price-delta="{{ val_price }}"
                          data-option-key="{{ block.settings.eg_wizard_option_code }}"
                          {% if val_stock == 'false' %}disabled aria-disabled="true"{% endif %}
                          {% if forloop.first %}checked{% endif %}
                        >
                        <span class="eg-wizard__radio-label">{{ val_label }}</span>
                        {%- if val_price != 0 -%}
                          <span class="eg-wizard__radio-price">{{ val_price | prepend: section.settings.eg_wizard_currency }}</span>
                        {%- endif -%}
                      </label>
                    {%- endfor -%}
                  </div>
                </div>
              {%- endif -%}
            {%- endfor -%}

            <div class="eg-wizard__option-group">
              <label class="eg-wizard__option-label" for="eg-wizard-engrave-{{ section.id }}">
                刻印テキスト（オプション）
              </label>
              <input
                type="text"
                id="eg-wizard-engrave-{{ section.id }}"
                name="properties[engrave_text]"
                class="eg-wizard__text-input"
                placeholder="例: My Keyboard"
                maxlength="20"
                data-option-key="engrave_text"
              >
              <p class="eg-wizard__input-help">最大20文字まで</p>
            </div>
          </div>
        </div>
      </form>

      {%- comment -%} Step 6: Summary {%- endcomment -%}
      <div class="eg-step eg-step--summary" data-step="6" data-step-id="summary">
        <div class="eg-step__content">
          <h3 class="eg-step__heading">注文内容の確認</h3>
          <p class="eg-step__description">選択内容を確認してカートに追加してください。</p>

          <div class="eg-wizard__summary" data-summary>
            <div class="eg-wizard__summary-item">
              <span class="eg-wizard__summary-label">手の写真:</span>
              <span class="eg-wizard__summary-value" data-summary-hand>アップロード済み</span>
            </div>
          </div>

          <div class="eg-wizard__total">
            <span class="eg-wizard__total-label">合計金額:</span>
            <span class="eg-wizard__total-price" data-total-price>¥0</span>
          </div>
        </div>
      </div>
    </div>

    {%- comment -%} Preview Sidebar {%- endcomment -%}
    <aside class="eg-wizard__preview" aria-live="polite" aria-label="プレビュー">
      <div class="eg-wizard__preview-container">
        <img
          src=""
          alt="キーボードプレビュー"
          class="eg-wizard__preview-image"
          data-preview-image
        >
        <div class="eg-wizard__price" data-price-display>
          {{ section.settings.eg_wizard_base_price | prepend: section.settings.eg_wizard_currency }}
        </div>
      </div>
    </aside>

    {%- comment -%} Navigation Footer {%- endcomment -%}
    <footer class="eg-wizard__nav">
      <button
        type="button"
        class="eg-wizard__btn eg-wizard__btn--secondary"
        data-prev
        disabled
      >
        ← 戻る
      </button>
      <button
        type="button"
        class="eg-wizard__btn eg-wizard__btn--primary"
        data-next
        disabled
      >
        次へ →
      </button>
      <button
        type="button"
        class="eg-wizard__btn eg-wizard__btn--cart"
        data-add-to-cart
        style="display: none;"
      >
        カートに追加
      </button>
    </footer>

    {%- comment -%} Toast Notification {%- endcomment -%}
    <div class="eg-wizard__toast" role="status" aria-live="polite" data-toast style="display: none;"></div>
  </div>

  {%- comment -%} Hidden Data for Preview Mapping {%- endcomment -%}
  <script type="application/json" data-preview-map>
    {
      {%- for item in section.settings.eg_wizard_preview_map -%}
        "{{ item.key }}": "{{ item.image | image_url: width: 800 }}"
        {%- unless forloop.last -%},{%- endunless -%}
      {%- endfor -%}
    }
  </script>

  {%- comment -%} Product Variant ID (if applicable) {%- endcomment -%}
  <input type="hidden" name="id" value="{{ section.settings.eg_wizard_product_variant }}" data-variant-id>
</section>

<script src="{{ 'ergo-wizard.js' | asset_url }}" defer></script>

{% schema %}
{
  "name": "Full Order Wizard",
  "tag": "section",
  "class": "section-fullorder-wizard",
  "settings": [
    {
      "type": "header",
      "content": "基本設定"
    },
    {
      "type": "number",
      "id": "eg_wizard_base_price",
      "label": "基本価格",
      "default": 50000,
      "info": "オーダーメイドの基本価格（円）"
    },
    {
      "type": "text",
      "id": "eg_wizard_currency",
      "label": "通貨記号",
      "default": "¥",
      "info": "価格表示の通貨記号"
    },
    {
      "type": "product",
      "id": "eg_wizard_product_variant",
      "label": "商品バリアント",
      "info": "カートに追加する商品（オプション）"
    },
    {
      "type": "header",
      "content": "プレビュー画像マッピング"
    },
    {
      "type": "textarea",
      "id": "eg_wizard_preview_map",
      "label": "プレビューマップ（JSON形式）",
      "default": "[\n  {\"key\": \"layout=qwerty&case=black\", \"image\": \"\"}\n]",
      "info": "キーと画像のマッピング。例: layout=qwerty&case=black"
    },
    {
      "type": "header",
      "content": "スタイル"
    },
    {
      "type": "range",
      "id": "eg_wizard_padding_y",
      "min": 40,
      "max": 120,
      "step": 10,
      "unit": "px",
      "label": "上下余白",
      "default": 60
    },
    {
      "type": "color",
      "id": "eg_wizard_fg",
      "label": "テキスト色",
      "default": "#1d1d1f"
    },
    {
      "type": "color",
      "id": "eg_wizard_bg",
      "label": "背景色",
      "default": "#ffffff"
    }
  ],
  "blocks": [
    {
      "type": "option",
      "name": "オプション",
      "settings": [
        {
          "type": "text",
          "id": "eg_wizard_option_name",
          "label": "オプション名",
          "default": "キーキャップタイプ"
        },
        {
          "type": "text",
          "id": "eg_wizard_option_code",
          "label": "オプションコード",
          "default": "keycap_type",
          "info": "例: keycap_color, switch_model, case_color, plate_material, layout, size"
        },
        {
          "type": "select",
          "id": "eg_wizard_option_type",
          "label": "表示タイプ",
          "options": [
            {
              "value": "radio",
              "label": "ラジオボタン"
            },
            {
              "value": "swatch",
              "label": "カラースウォッチ"
            }
          ],
          "default": "radio"
        },
        {
          "type": "textarea",
          "id": "eg_wizard_option_values",
          "label": "値（1行1つ）",
          "default": "ABS|abs|0|true\nPBT|pbt|5000|true\nMX|mx|3000|false",
          "info": "フォーマット: ラベル|値|価格差分|在庫(true/false)|色コード(swatchのみ)\n例: ブラック|black|0|true|#000000"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Full Order Wizard",
      "blocks": [
        {
          "type": "option",
          "settings": {
            "eg_wizard_option_name": "キーキャップタイプ",
            "eg_wizard_option_code": "keycap_type",
            "eg_wizard_option_type": "radio",
            "eg_wizard_option_values": "ABS|abs|0|true\nPBT|pbt|5000|true"
          }
        },
        {
          "type": "option",
          "settings": {
            "eg_wizard_option_name": "キーキャップカラー",
            "eg_wizard_option_code": "keycap_color",
            "eg_wizard_option_type": "swatch",
            "eg_wizard_option_values": "ブラック|black|0|true|#000000\nホワイト|white|0|true|#ffffff\nグレー|gray|0|true|#808080"
          }
        },
        {
          "type": "option",
          "settings": {
            "eg_wizard_option_name": "スイッチ",
            "eg_wizard_option_code": "switch_model",
            "eg_wizard_option_type": "radio",
            "eg_wizard_option_values": "Cherry MX Red|mx_red|0|true\nCherry MX Blue|mx_blue|0|true\nGateron Yellow|gateron_yellow|3000|true"
          }
        },
        {
          "type": "option",
          "settings": {
            "eg_wizard_option_name": "本体カラー",
            "eg_wizard_option_code": "case_color",
            "eg_wizard_option_type": "swatch",
            "eg_wizard_option_values": "ブラック|black|0|true|#000000\nシルバー|silver|5000|true|#c0c0c0\nアイボリー|ivory|5000|true|#fffff0"
          }
        },
        {
          "type": "option",
          "settings": {
            "eg_wizard_option_name": "プレート素材",
            "eg_wizard_option_code": "plate_material",
            "eg_wizard_option_type": "radio",
            "eg_wizard_option_values": "アルミニウム|aluminum|0|true\nブラス|brass|8000|true\nポリカーボネート|polycarbonate|3000|true"
          }
        },
        {
          "type": "option",
          "settings": {
            "eg_wizard_option_name": "配列",
            "eg_wizard_option_code": "layout",
            "eg_wizard_option_type": "radio",
            "eg_wizard_option_values": "QWERTY|qwerty|0|true\nColemak|colemak|0|true\nDvorak|dvorak|0|true"
          }
        },
        {
          "type": "option",
          "settings": {
            "eg_wizard_option_name": "サイズ",
            "eg_wizard_option_code": "size",
            "eg_wizard_option_type": "radio",
            "eg_wizard_option_values": "60%|60|0|true\n75%|75|5000|true\nTKL|tkl|8000|true"
          }
        }
      ]
    }
  ]
}
{% endschema %}
