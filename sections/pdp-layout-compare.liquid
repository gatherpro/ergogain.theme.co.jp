{% comment %}
  PDP Layout Compare - 手の計測データに基づくキーボードレイアウト最適化比較

  使い方：
  1. 管理画面 > オンラインストア > テーマ > カスタマイズ
  2. 「セクションを追加」> 「PDP Layout Compare」を選択
  3. ブロックを追加してレイアウトカードを作成
  4. 各レイアウトに最適化スコアと計測データを設定

  機能：
  - 手の計測データに基づく最適化スコア表示
  - 適合度の視覚化（プログレスバー、スコア表示）
  - 推奨順での自動ソート機能
  - インタラクティブな比較UI
  - レスポンシブ対応
{% endcomment %}

<style>
  .pdp-layout {
    padding: 6rem 0;
    background: linear-gradient(180deg, #fafafa 0%, #ffffff 100%);
  }

  .pdp-layout__header {
    max-width: 1280px;
    margin: 0 auto 3rem;
    padding: 0 2rem;
    text-align: center;
  }

  .pdp-layout__heading {
    font-size: 3.6rem;
    font-weight: 700;
    line-height: 1.2;
    margin: 0 0 1.6rem;
    color: #1d1d1f;
  }

  @media screen and (max-width: 768px) {
    .pdp-layout__heading {
      font-size: 2.8rem;
    }
  }

  .pdp-layout__subtext {
    font-size: 1.8rem;
    line-height: 1.5;
    color: #6e6e73;
    margin: 0 0 2rem;
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
  }

  .pdp-layout__measurement-summary {
    display: inline-flex;
    align-items: center;
    gap: 1.2rem;
    padding: 1rem 2rem;
    background: #fff;
    border: 1px solid #e5e5e7;
    border-radius: 2rem;
    font-size: 1.4rem;
    color: #6e6e73;
    margin-top: 1rem;
  }

  .pdp-layout__measurement-icon {
    width: 2rem;
    height: 2rem;
    color: #0071e3;
  }

  .pdp-layout__container {
    position: relative;
    max-width: 1440px;
    margin: 0 auto;
    padding: 0 2rem;
  }

  .pdp-layout__grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 2rem;
    margin-bottom: 2rem;
  }

  @media screen and (min-width: 768px) {
    .pdp-layout__grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media screen and (min-width: 1024px) {
    .pdp-layout__grid {
      grid-template-columns: repeat(3, 1fr);
      gap: 2.4rem;
    }
  }

  @media screen and (min-width: 1280px) {
    .pdp-layout__grid {
      grid-template-columns: repeat(4, 1fr);
    }
  }

  .pdp-layout__card {
    background: #fff;
    border-radius: 1.6rem;
    overflow: hidden;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    position: relative;
  }

  .pdp-layout__card:hover {
    transform: translateY(-6px);
    box-shadow: 0 12px 32px rgba(0, 0, 0, 0.12);
  }

  .pdp-layout__card--recommended {
    border: 2px solid #0071e3;
  }

  .pdp-layout__badge {
    position: absolute;
    top: 1.6rem;
    right: 1.6rem;
    z-index: 2;
    padding: 0.6rem 1.2rem;
    background: #0071e3;
    color: #fff;
    font-size: 1.2rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    border-radius: 0.6rem;
    box-shadow: 0 2px 8px rgba(0, 113, 227, 0.3);
  }

  .pdp-layout__image-wrapper {
    position: relative;
    width: 100%;
    padding-top: 75%;
    background: linear-gradient(135deg, #f5f5f7 0%, #e8e8ed 100%);
    overflow: hidden;
  }

  .pdp-layout__image {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
  }

  .pdp-layout__card:hover .pdp-layout__image {
    transform: scale(1.05);
  }

  .pdp-layout__content {
    padding: 2rem;
  }

  .pdp-layout__title {
    font-size: 2rem;
    font-weight: 600;
    line-height: 1.3;
    margin: 0 0 0.8rem;
    color: #1d1d1f;
  }

  .pdp-layout__one-liner {
    font-size: 1.4rem;
    line-height: 1.5;
    color: #6e6e73;
    margin: 0 0 1.6rem;
    min-height: 4.2rem;
  }

  .pdp-layout__score-section {
    margin-bottom: 1.6rem;
    padding: 1.6rem;
    background: #f5f5f7;
    border-radius: 1.2rem;
  }

  .pdp-layout__score-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }

  .pdp-layout__score-label {
    font-size: 1.3rem;
    font-weight: 500;
    color: #6e6e73;
  }

  .pdp-layout__score-value {
    font-size: 2rem;
    font-weight: 700;
    color: #1d1d1f;
  }

  .pdp-layout__score-value--high {
    color: #34c759;
  }

  .pdp-layout__score-value--medium {
    color: #ff9500;
  }

  .pdp-layout__score-value--low {
    color: #ff3b30;
  }

  .pdp-layout__progress-bar {
    width: 100%;
    height: 0.8rem;
    background: #e5e5e7;
    border-radius: 0.4rem;
    overflow: hidden;
  }

  .pdp-layout__progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #34c759 0%, #30d158 100%);
    transition: width 0.6s ease;
  }

  .pdp-layout__progress-fill--medium {
    background: linear-gradient(90deg, #ff9500 0%, #ffb340 100%);
  }

  .pdp-layout__progress-fill--low {
    background: linear-gradient(90deg, #ff3b30 0%, #ff6961 100%);
  }

  .pdp-layout__metrics {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1.6rem;
  }

  .pdp-layout__metric {
    text-align: center;
    padding: 1rem;
    background: #f9f9fb;
    border-radius: 0.8rem;
  }

  .pdp-layout__metric-label {
    font-size: 1.2rem;
    color: #86868b;
    margin-bottom: 0.4rem;
  }

  .pdp-layout__metric-value {
    font-size: 1.6rem;
    font-weight: 600;
    color: #1d1d1f;
  }

  .pdp-layout__link {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    padding: 1.2rem 2rem;
    font-size: 1.5rem;
    font-weight: 600;
    color: #0071e3;
    background: transparent;
    border: 2px solid #0071e3;
    border-radius: 0.8rem;
    text-decoration: none;
    transition: all 0.2s ease;
  }

  .pdp-layout__link:hover {
    background: #0071e3;
    color: #fff;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 113, 227, 0.3);
  }

  .pdp-layout__link:focus-visible {
    outline: 2px solid #0071e3;
    outline-offset: 4px;
  }

  .pdp-layout__card--recommended .pdp-layout__link {
    background: #0071e3;
    color: #fff;
  }

  .pdp-layout__card--recommended .pdp-layout__link:hover {
    background: #0051a8;
    border-color: #0051a8;
  }

  .pdp-layout__sort-controls {
    display: flex;
    justify-content: center;
    gap: 1.2rem;
    margin-bottom: 3rem;
    flex-wrap: wrap;
  }

  .pdp-layout__sort-btn {
    padding: 1rem 2rem;
    font-size: 1.4rem;
    font-weight: 500;
    color: #6e6e73;
    background: #fff;
    border: 1px solid #d1d1d6;
    border-radius: 2rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .pdp-layout__sort-btn:hover {
    color: #0071e3;
    border-color: #0071e3;
  }

  .pdp-layout__sort-btn--active {
    color: #fff;
    background: #0071e3;
    border-color: #0071e3;
  }

  @media (prefers-reduced-motion: reduce) {
    .pdp-layout__card,
    .pdp-layout__image,
    .pdp-layout__link,
    .pdp-layout__progress-fill {
      transition: none;
    }
  }
</style>

<section
  class="pdp-layout"
  role="region"
  aria-label="{{ section.settings.heading | escape }}"
>
  <div class="pdp-layout__header">
    {%- if section.settings.heading != blank -%}
      <h2 class="pdp-layout__heading">{{ section.settings.heading }}</h2>
    {%- endif -%}
    {%- if section.settings.subtext != blank -%}
      <p class="pdp-layout__subtext">{{ section.settings.subtext }}</p>
    {%- endif -%}
    {%- if section.settings.show_measurement_summary -%}
      <div class="pdp-layout__measurement-summary">
        <svg class="pdp-layout__measurement-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
          <circle cx="12" cy="7" r="4"></circle>
        </svg>
        <span>あなたの手のサイズに基づいて最適化されています</span>
      </div>
    {%- endif -%}
  </div>

  <div class="pdp-layout__container">
    {%- if section.settings.show_sort_controls -%}
      <div class="pdp-layout__sort-controls">
        <button class="pdp-layout__sort-btn pdp-layout__sort-btn--active" data-sort="recommended">
          推奨順
        </button>
        <button class="pdp-layout__sort-btn" data-sort="score">
          スコア順
        </button>
        <button class="pdp-layout__sort-btn" data-sort="name">
          名前順
        </button>
      </div>
    {%- endif -%}

    <div class="pdp-layout__grid" data-layout-grid>
      {%- for block in section.blocks -%}
        <div
          class="pdp-layout__card{% if block.settings.is_recommended %} pdp-layout__card--recommended{% endif %}"
          data-score="{{ block.settings.optimization_score }}"
          data-name="{{ block.settings.title }}"
          data-recommended="{{ block.settings.is_recommended }}"
          {{ block.shopify_attributes }}
        >
          {%- if block.settings.is_recommended -%}
            <div class="pdp-layout__badge">推奨</div>
          {%- endif -%}

          {%- if block.settings.image != blank -%}
            <div class="pdp-layout__image-wrapper">
              {%- assign image_height = block.settings.image.width | divided_by: 1.333 | round -%}
              <img
                class="pdp-layout__image"
                srcset="
                  {%- if block.settings.image.width >= 375 -%}{{ block.settings.image | image_url: width: 375 }} 375w,{%- endif -%}
                  {%- if block.settings.image.width >= 550 -%}{{ block.settings.image | image_url: width: 550 }} 550w,{%- endif -%}
                  {%- if block.settings.image.width >= 750 -%}{{ block.settings.image | image_url: width: 750 }} 750w,{%- endif -%}
                  {%- if block.settings.image.width >= 1100 -%}{{ block.settings.image | image_url: width: 1100 }} 1100w{%- endif -%}
                "
                src="{{ block.settings.image | image_url: width: 750 }}"
                sizes="(min-width: 1280px) 25vw, (min-width: 1024px) 33vw, (min-width: 768px) 50vw, 100vw"
                alt="{{ block.settings.image.alt | default: block.settings.title | escape }}"
                loading="lazy"
                width="{{ block.settings.image.width }}"
                height="{{ image_height }}"
              >
            </div>
          {%- endif -%}

          <div class="pdp-layout__content">
            {%- if block.settings.title != blank -%}
              <h3 class="pdp-layout__title">{{ block.settings.title }}</h3>
            {%- endif -%}

            {%- if block.settings.one_liner != blank -%}
              <p class="pdp-layout__one-liner">{{ block.settings.one_liner }}</p>
            {%- endif -%}

            {%- if block.settings.optimization_score > 0 -%}
              <div class="pdp-layout__score-section">
                <div class="pdp-layout__score-header">
                  <span class="pdp-layout__score-label">最適化スコア</span>
                  <span class="pdp-layout__score-value {% if block.settings.optimization_score >= 80 %}pdp-layout__score-value--high{% elsif block.settings.optimization_score >= 60 %}pdp-layout__score-value--medium{% else %}pdp-layout__score-value--low{% endif %}">
                    {{ block.settings.optimization_score }}%
                  </span>
                </div>
                <div class="pdp-layout__progress-bar">
                  <div
                    class="pdp-layout__progress-fill {% if block.settings.optimization_score >= 80 %}{% elsif block.settings.optimization_score >= 60 %}pdp-layout__progress-fill--medium{% else %}pdp-layout__progress-fill--low{% endif %}"
                    style="width: {{ block.settings.optimization_score }}%"
                  ></div>
                </div>
              </div>
            {%- endif -%}

            {%- if block.settings.show_metrics -%}
              <div class="pdp-layout__metrics">
                <div class="pdp-layout__metric">
                  <div class="pdp-layout__metric-label">快適性</div>
                  <div class="pdp-layout__metric-value">{{ block.settings.comfort_score }}%</div>
                </div>
                <div class="pdp-layout__metric">
                  <div class="pdp-layout__metric-label">効率性</div>
                  <div class="pdp-layout__metric-value">{{ block.settings.efficiency_score }}%</div>
                </div>
              </div>
            {%- endif -%}

            {%- if block.settings.link_label != blank and block.settings.link_url != blank -%}
              <a href="{{ block.settings.link_url }}" class="pdp-layout__link">
                {{ block.settings.link_label }}
              </a>
            {%- endif -%}
          </div>
        </div>
      {%- endfor -%}
    </div>
  </div>
</section>

<script>
(function() {
  class PDPLayoutCompare {
    constructor(element) {
      this.section = element;
      this.grid = this.section.querySelector('[data-layout-grid]');
      this.cards = Array.from(this.section.querySelectorAll('.pdp-layout__card'));
      this.sortButtons = Array.from(this.section.querySelectorAll('.pdp-layout__sort-btn'));

      if (!this.grid || this.cards.length === 0) return;

      this.init();
    }

    init() {
      // Sort button handlers
      this.sortButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const sortType = btn.dataset.sort;
          this.sortCards(sortType);

          // Update active state
          this.sortButtons.forEach(b => b.classList.remove('pdp-layout__sort-btn--active'));
          btn.classList.add('pdp-layout__sort-btn--active');
        });
      });

      // Initial sort by recommended
      this.sortCards('recommended');

      // Animate progress bars on load
      setTimeout(() => {
        this.animateProgressBars();
      }, 300);
    }

    sortCards(sortType) {
      let sortedCards = [...this.cards];

      switch(sortType) {
        case 'recommended':
          sortedCards.sort((a, b) => {
            const aRec = a.dataset.recommended === 'true' ? 1 : 0;
            const bRec = b.dataset.recommended === 'true' ? 1 : 0;
            if (bRec !== aRec) return bRec - aRec;
            return parseFloat(b.dataset.score) - parseFloat(a.dataset.score);
          });
          break;

        case 'score':
          sortedCards.sort((a, b) => {
            return parseFloat(b.dataset.score) - parseFloat(a.dataset.score);
          });
          break;

        case 'name':
          sortedCards.sort((a, b) => {
            return a.dataset.name.localeCompare(b.dataset.name);
          });
          break;
      }

      // Re-append cards in sorted order
      sortedCards.forEach(card => {
        this.grid.appendChild(card);
      });
    }

    animateProgressBars() {
      const progressBars = this.section.querySelectorAll('.pdp-layout__progress-fill');
      progressBars.forEach(bar => {
        const width = bar.style.width;
        bar.style.width = '0%';
        setTimeout(() => {
          bar.style.width = width;
        }, 100);
      });
    }
  }

  // Initialize all PDP Layout Compare sections
  document.addEventListener('DOMContentLoaded', () => {
    const sections = document.querySelectorAll('.pdp-layout');
    sections.forEach(section => new PDPLayoutCompare(section));
  });

  // Reinitialize on Shopify theme editor events
  if (window.Shopify && window.Shopify.designMode) {
    document.addEventListener('shopify:section:load', (event) => {
      const section = event.target.querySelector('.pdp-layout');
      if (section) new PDPLayoutCompare(section);
    });
  }
})();
</script>

{% schema %}
{
  "name": "PDP Layout Compare",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "header",
      "content": "見出し"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "見出し",
      "default": "あなたに最適なレイアウト"
    },
    {
      "type": "textarea",
      "id": "subtext",
      "label": "説明文",
      "default": "手を実際に計測して、最適化プログラムで作成したレイアウトから選択できます。"
    },
    {
      "type": "header",
      "content": "表示設定"
    },
    {
      "type": "checkbox",
      "id": "show_measurement_summary",
      "label": "計測データサマリーを表示",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_sort_controls",
      "label": "ソートコントロールを表示",
      "default": true
    }
  ],
  "blocks": [
    {
      "type": "layout_card",
      "name": "レイアウトカード",
      "settings": [
        {
          "type": "header",
          "content": "基本情報"
        },
        {
          "type": "image_picker",
          "id": "image",
          "label": "画像"
        },
        {
          "type": "text",
          "id": "title",
          "label": "タイトル",
          "default": "60% コンパクト"
        },
        {
          "type": "textarea",
          "id": "one_liner",
          "label": "説明（1-2行）",
          "default": "省スペースで持ち運びやすい、ミニマリスト向けレイアウト。"
        },
        {
          "type": "header",
          "content": "最適化データ"
        },
        {
          "type": "checkbox",
          "id": "is_recommended",
          "label": "推奨レイアウトとして表示",
          "default": false
        },
        {
          "type": "range",
          "id": "optimization_score",
          "min": 0,
          "max": 100,
          "step": 1,
          "unit": "%",
          "label": "最適化スコア",
          "default": 85,
          "info": "手の計測データに基づく総合スコア"
        },
        {
          "type": "checkbox",
          "id": "show_metrics",
          "label": "詳細メトリクスを表示",
          "default": true
        },
        {
          "type": "range",
          "id": "comfort_score",
          "min": 0,
          "max": 100,
          "step": 1,
          "unit": "%",
          "label": "快適性スコア",
          "default": 90
        },
        {
          "type": "range",
          "id": "efficiency_score",
          "min": 0,
          "max": 100,
          "step": 1,
          "unit": "%",
          "label": "効率性スコア",
          "default": 80
        },
        {
          "type": "header",
          "content": "リンク"
        },
        {
          "type": "text",
          "id": "link_label",
          "label": "リンクラベル",
          "default": "詳細を見る"
        },
        {
          "type": "url",
          "id": "link_url",
          "label": "リンクURL"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "PDP Layout Compare",
      "blocks": [
        {
          "type": "layout_card",
          "settings": {
            "title": "60% コンパクト",
            "optimization_score": 92,
            "is_recommended": true,
            "comfort_score": 95,
            "efficiency_score": 88
          }
        },
        {
          "type": "layout_card",
          "settings": {
            "title": "75% バランス",
            "optimization_score": 88,
            "comfort_score": 90,
            "efficiency_score": 86
          }
        },
        {
          "type": "layout_card",
          "settings": {
            "title": "TKL テンキーレス",
            "optimization_score": 75,
            "comfort_score": 80,
            "efficiency_score": 70
          }
        },
        {
          "type": "layout_card",
          "settings": {
            "title": "分割型",
            "optimization_score": 85,
            "comfort_score": 92,
            "efficiency_score": 78
          }
        }
      ]
    }
  ]
}
{% endschema %}
